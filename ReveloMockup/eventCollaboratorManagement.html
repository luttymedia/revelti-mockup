<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revelo - Colaborator Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Nunito -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Your Custom Stylesheet -->
    <link rel="stylesheet" href="style.css">
     
</head>
<body class="bg-gray-100 antialiased text-gray-800 pt-8">
    <!-- Organizer-specific Navbar -->
    <div id="organizer-navbar-placeholder"></div>

    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header Section -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div>
                <div class="flex items-center">
                    <h1 class="text-3xl font-extrabold revelo-blue">Sensuality & Essentiality</h1>
                    <span class="ml-4 text-sm font-bold bg-green-100 text-green-800 px-3 py-1 rounded-full whitespace-nowrap">On Sale</span>
                </div>
                <p class="text-gray-600">Collaborator Management</p>
            </div>
            <div class="flex space-x-2 mt-4 md:mt-0">
                <a href="eventDetailOrganizerView.html" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-300">View Public Page</a>
                <a href="eventLiveEdit.html" class="px-4 py-2 bg-revelo-blue text-white rounded-lg hover:bg-blue-800 transition duration-300">Live Edit Page</a>
            </div>
        </header>
        
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <main class="p-6 md:p-8 space-y-6">
                
                <!-- Creators Section -->
                <details open class="border rounded-lg">
                    <summary class="flex justify-between items-center cursor-pointer p-4">
                        <h2 class="font-bold text-xl revelo-blue">Media Creators</h2>
                        <svg class="w-5 h-5 transform transition-transform accordion-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="p-4 border-t">
                        <div class="flex justify-end mb-4">
                            <button onclick="openInviteModal('creator')" class="px-4 py-2 font-bold bg-revelo-blue text-white rounded-lg hover:bg-blue-800 text-sm">Invite Media Creator</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Media Creator</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Collaborating Galleries</th>
                                        <th class="px-4 py-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="creators-table-body" class="divide-y divide-gray-200">
                                    <!-- Creator rows will be injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>

                <!-- Promoters Section -->
                <details open class="border rounded-lg">
                    <summary class="flex justify-between items-center cursor-pointer p-4">
                        <h2 class="font-bold text-xl revelo-blue">Promoters</h2>
                        <svg class="w-5 h-5 transform transition-transform accordion-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="p-4 border-t">
                        <div class="flex justify-end mb-4">
                            <button onclick="openInviteModal('promoter')" class="px-4 py-2 font-bold bg-revelo-blue text-white rounded-lg hover:bg-blue-800 text-sm">Invite Promoter</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Promoter</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Discount Code</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sales / Uses</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Revenue</th>
                                        <th class="px-4 py-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="promoters-table-body" class="divide-y divide-gray-200">
                                    <!-- Promoter rows will be injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </details>

            </main>
        </div>
    </div>

    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40" onclick="closeAllModals()"></div>
    
    <!-- Edit Creator Modal -->
    <div id="edit-creator-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center">
                <h3 id="creator-modal-title" class="font-bold text-xl revelo-blue"></h3>
                <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </header>
            <main class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="editing-creator-id">
                <div>
                    <label class="font-semibold text-gray-700">Gallery Permissions</label>
                    <p class="text-sm text-gray-500 mb-2">Grant or revoke access to specific gallery folders for this event.</p>
                    <div id="gallery-permissions-tree" class="space-y-2 border p-3 rounded-md max-h-60 overflow-y-auto">
                        <!-- Tree generated by JS -->
                    </div>
                </div>
            </main>
            <footer class="p-4 border-t flex justify-between items-center bg-gray-50">
                <div>
                    <button id="creator-revoke-btn" onclick="handleCreatorAction('Revoked')" class="px-4 py-2 font-bold bg-red-600 text-white rounded-lg text-sm">Revoke Access</button>
                    <button id="creator-cancel-btn" onclick="handleCreatorAction('Cancelled')" class="px-4 py-2 font-bold bg-revelo-orange hover:bg-orange-600 text-white rounded-lg text-sm">Cancel Invitation</button>
                </div>
                <div class="space-x-2">
                    <button onclick="closeAllModals()" class="px-4 py-2 font-semibold bg-gray-200 text-gray-700 rounded-lg">Cancel</button>
                    <button onclick="saveCreator()" class="px-4 py-2 font-bold bg-revelo-blue text-white rounded-lg">Save Changes</button>
                </div>
            </footer>
        </div>
    </div>

    <!-- Manage Promoter Modal (for Confirmed) -->
    <div id="manage-promoter-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <header class="p-4 border-b flex justify-between items-center">
                <h3 id="manage-promoter-modal-title" class="font-bold text-xl revelo-blue"></h3>
                <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </header>
            <main class="p-6 space-y-4 text-center">
                 <input type="hidden" id="editing-promoter-id">
                <p>Visit the Ticket Management dashboard to create, assign, and monitor all promoter-specific discount codes.</p>
                <a href="ticketManagement.html" class="inline-block w-full px-6 py-3 font-bold bg-revelo-blue text-white rounded-lg hover:bg-blue-800 transition duration-300">
                    Go to Ticket Management
                </a>
            </main>
        </div>
    </div>

    <!-- Cancel Promoter Modal (for Pending) -->
    <div id="cancel-promoter-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 space-y-4">
            <h3 id="cancel-promoter-modal-title" class="font-bold text-xl revelo-blue"></h3>
            <p>Are you sure you want to cancel this pending invitation?</p>
            <div class="flex justify-end space-x-2 pt-4 border-t">
                <button onclick="closeAllModals()" class="px-4 py-2 font-semibold bg-gray-200 text-gray-700 rounded-lg">Back</button>
                <button onclick="handlePromoterAction('Cancelled')" class="px-4 py-2 font-bold bg-revelo-orange hover:bg-orange-600 text-white rounded-lg">Cancel Invitation</button>
            </div>
        </div>
    </div>
    
    <!-- Generic Invite Modal -->
    <div id="invite-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 space-y-4">
            <h3 id="invite-modal-title" class="font-bold text-xl revelo-blue"></h3>
            <p id="invite-modal-text"></p>
            <input type="text" id="invite-modal-search" class="w-full p-2 border border-gray-300 rounded-md mt-1">
            <div class="flex justify-end space-x-2">
                <button onclick="closeAllModals()" class="px-4 py-2 font-semibold bg-gray-200 text-gray-700 rounded-lg">Cancel</button>
                <button onclick="alert('Invitation sent!'); closeAllModals();" class="px-4 py-2 font-bold bg-revelo-blue text-white rounded-lg">Send Invite</button>
            </div>
        </div>
    </div>


    <script>
        // --- DATA ---
        let collaboratorsData = {
            creators: [
                { id: 1, name: 'AMedia', avatar: 'https://placehold.co/80x80/f58220/ffffff?text=A', status: 'Confirmed', permissions: ['root', 'sat', 'sat-photos', 'jandj', 'sat-videos', 'sun', 'sun-photos', 'sun-social'] },
                { id: 2, name: 'Lutty Moreira', avatar: 'https://placehold.co/80x80/f58220/ffffff?text=LM', status: 'Confirmed', permissions: ['workshops'] },
                { id: 3, name: 'Sha Iborra', avatar: 'https://placehold.co/80x80/f58220/ffffff?text=SI', status: 'Pending', permissions: [] },
                { id: 4, name: 'Visuals Pro', avatar: 'https://placehold.co/80x80/cccccc/ffffff?text=V', status: 'Declined', permissions: [] }
            ],
            promoters: [
                { id: 1, name: 'DJ Sparkus', avatar: 'https://placehold.co/80x80/213c63/ffffff?text=DS', status: 'Confirmed', code: 'DJSPARKUS10', sales: 45, uses: 100, revenue: 9500.50 },
                { id: 2, name: 'ProDancers', avatar: 'https://placehold.co/80x80/213c63/ffffff?text=PD', status: 'Confirmed', code: 'PROD8', sales: 148, uses: 200, revenue: 31228.00 },
                { id: 3, name: 'PartyPros', avatar: 'https://placehold.co/80x80/213c63/ffffff?text=PP', status: 'Confirmed', code: 'PART8', sales: 283, uses: 300, revenue: 65771.00 },
                { id: 4, name: 'DanceWorld', avatar: 'https://placehold.co/80x80/213c63/ffffff?text=DW', status: 'Confirmed', code: 'DANCE10', sales: 78, uses: 150, revenue: 15000.00 },
                { id: 5, name: 'SensualPromo', avatar: 'https://placehold.co/80x80/213c63/ffffff?text=SP', status: 'Confirmed', code: 'SENS15', sales: 112, uses: 150, revenue: 21000.00 },
                { id: 6, name: 'John Doe', avatar: 'https://placehold.co/80x80/cccccc/ffffff?text=JD', status: 'Pending', code: '', sales: 0, uses: 0, revenue: 0 },
                { id: 7, name: 'Jane Smith', avatar: 'https://placehold.co/80x80/cccccc/ffffff?text=JS', status: 'Declined', code: '', sales: 0, uses: 0, revenue: 0 }
            ]
        };

        const galleryStructure = {
            id: 'root', name: 'Sensuality 2025', children: [
                { id: 'sat', name: 'Saturday 01-Nov', children: [
                    { id: 'sat-photos', name: 'Photos', children: [
                        { id: 'workshops', name: 'Workshops', children: [] },
                        { id: 'jandj', name: 'Jack & Jill', children: [] },
                    ]},
                    { id: 'sat-videos', name: 'Videos', children: [] }
                ]},
                { id: 'sun', name: 'Sunday 02-Nov', children: [
                    { id: 'sun-photos', name: 'Photos', children: [
                        { id: 'sun-social', name: 'Sunday Social', children: [] },
                    ]}
                ]}
            ]
        };
        
        const galleryNameMap = {};
        function flattenGallery(node) {
            galleryNameMap[node.id] = node.name;
            if (node.children) {
                node.children.forEach(flattenGallery);
            }
        }
        flattenGallery(galleryStructure);


        // --- RENDER FUNCTIONS ---
        const getStatusBadge = (status) => {
            switch (status) {
                case 'Confirmed': return `<span class="text-xs font-semibold bg-green-100 text-green-800 px-2 py-1 rounded-full">${status}</span>`;
                case 'Pending': return `<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">${status}</span>`;
                case 'Declined': return `<span class="text-xs font-semibold bg-red-100 text-red-800 px-2 py-1 rounded-full">${status}</span>`;
                case 'Cancelled':
                case 'Revoked':
                    return `<span class="text-xs font-semibold bg-gray-200 text-gray-800 px-2 py-1 rounded-full">${status}</span>`;
                default: return '';
            }
        };

        const formatCurrency = (amount) => `â‚¬${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        function renderCreators() {
            const tableBody = document.getElementById('creators-table-body');
            tableBody.innerHTML = '';
            collaboratorsData.creators.forEach(creator => {
                const row = document.createElement('tr');
                const isActionable = creator.status === 'Confirmed' || creator.status === 'Pending';
                
                const permissionNames = creator.permissions.map(id => galleryNameMap[id]).filter(Boolean);

                let permissionsHtml;
                if (permissionNames.length > 0) {
                    const tagsToShow = permissionNames.slice(0, 4);
                    const remainingCount = permissionNames.length - tagsToShow.length;
                    permissionsHtml = `<div class="flex flex-wrap gap-1 items-center">
                        ${tagsToShow.map(name => `<span class="text-xs bg-gray-200 text-gray-800 px-2 py-1 rounded-full">${name}</span>`).join('')}
                        ${remainingCount > 0 ? `<span class="text-xs bg-gray-300 text-gray-900 px-2 py-1 rounded-full">+${remainingCount}</span>` : ''}
                    </div>`;
                } else {
                    permissionsHtml = `<span class="text-gray-400 italic text-sm">${creator.status === 'Pending' ? 'Awaiting confirmation' : '-'}</span>`;
                }

                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <img class="h-10 w-10 rounded-full object-cover" src="${creator.avatar}" alt="${creator.name} Avatar">
                            <div class="ml-4"><div class="font-semibold">${creator.name}</div></div>
                        </div>
                    </td>
                    <td class="px-4 py-3">${getStatusBadge(creator.status)}</td>
                    <td class="px-4 py-3">${permissionsHtml}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="openCreatorModal(${creator.id})" class="text-sm font-semibold revelo-blue" ${!isActionable ? 'disabled' : ''}>Edit</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderPromoters() {
            const tableBody = document.getElementById('promoters-table-body');
            tableBody.innerHTML = '';
            collaboratorsData.promoters.forEach(promoter => {
                const row = document.createElement('tr');
                const isActionable = promoter.status === 'Confirmed' || promoter.status === 'Pending';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <img class="h-10 w-10 rounded-full object-cover" src="${promoter.avatar}" alt="${promoter.name} Avatar">
                            <div class="ml-4"><div class="font-semibold">${promoter.name}</div></div>
                        </div>
                    </td>
                    <td class="px-4 py-3">${getStatusBadge(promoter.status)}</td>
                    <td class="px-4 py-3 font-mono text-sm">${promoter.code || '<span class="text-gray-400 italic">None</span>'}</td>
                    <td class="px-4 py-3">${promoter.uses > 0 ? `${promoter.sales} / ${promoter.uses}`: '-'}</td>
                    <td class="px-4 py-3">${promoter.revenue > 0 ? formatCurrency(promoter.revenue) : '<span class="text-gray-400">-</span>'}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="openPromoterModal(${promoter.id})" class="text-sm font-semibold revelo-blue" ${!isActionable ? 'disabled' : ''}>Manage</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- MODAL LOGIC ---
        const modalBackdrop = document.getElementById('modal-backdrop');
        const allModals = document.querySelectorAll('.modal');

        function closeAllModals() {
            allModals.forEach(modal => modal.classList.add('hidden'));
            modalBackdrop.classList.add('hidden');
        }

        function openInviteModal(type) {
            const modal = document.getElementById('invite-modal');
            const title = document.getElementById('invite-modal-title');
            const text = document.getElementById('invite-modal-text');
            const search = document.getElementById('invite-modal-search');

            if (type === 'creator') {
                title.textContent = 'Invite a Media Creator';
                text.textContent = 'Search for a user by name or email to invite them as a Media Creator for this event.';
                search.placeholder = 'Search creators...';
            } else {
                title.textContent = 'Invite a Promoter';
                text.textContent = 'Search for a user by name or email to invite them as a Promoter for this event.';
                search.placeholder = 'Search promoters...';
            }
            modal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
        }

        function buildPermissionTree(node, creatorPermissions, level = 0) {
            const isChecked = creatorPermissions.includes(node.id);
            let html = `<div class="space-y-2" style="padding-left: ${level * 1.5}rem;">`;
            html += `<label class="flex items-center"><input type="checkbox" data-id="${node.id}" ${isChecked ? 'checked' : ''} class="mr-2 h-4 w-4"> ${node.name}</label>`;
            
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                node.children.forEach(child => {
                    childrenContainer.innerHTML += buildPermissionTree(child, creatorPermissions, level + 1);
                });
                html += childrenContainer.innerHTML;
            }
            html += `</div>`;
            return html;
        }

        function openCreatorModal(creatorId) {
            const creator = collaboratorsData.creators.find(c => c.id === creatorId);
            if (!creator) return;

            document.getElementById('editing-creator-id').value = creator.id;
            document.getElementById('creator-modal-title').textContent = `Edit Creator: ${creator.name}`;
            
            const treeContainer = document.getElementById('gallery-permissions-tree');
            treeContainer.innerHTML = buildPermissionTree(galleryStructure, creator.permissions);

            document.getElementById('creator-revoke-btn').style.display = creator.status === 'Confirmed' ? 'inline-block' : 'none';
            document.getElementById('creator-cancel-btn').style.display = creator.status === 'Pending' ? 'inline-block' : 'none';

            document.getElementById('edit-creator-modal').classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
        }
        
        function handleCreatorAction(newStatus) {
            const creatorId = parseInt(document.getElementById('editing-creator-id').value);
            const creator = collaboratorsData.creators.find(c => c.id === creatorId);
            if (!creator) return;

            creator.status = newStatus;
            if (newStatus === 'Revoked') {
                creator.permissions = [];
            }
            renderCreators();
            closeAllModals();
        }

        function saveCreator() {
            const creatorId = parseInt(document.getElementById('editing-creator-id').value);
            const creator = collaboratorsData.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const newPermissions = [];
            document.querySelectorAll('#gallery-permissions-tree input[type="checkbox"]:checked').forEach(checkbox => {
                newPermissions.push(checkbox.dataset.id);
            });
            creator.permissions = newPermissions;

            renderCreators();
            closeAllModals();
        }

        function openPromoterModal(promoterId) {
            const promoter = collaboratorsData.promoters.find(p => p.id === promoterId);
            if (!promoter) return;

            document.getElementById('editing-promoter-id').value = promoter.id;

            if (promoter.status === 'Pending') {
                document.getElementById('cancel-promoter-modal-title').textContent = `Cancel invitation for ${promoter.name}?`;
                document.getElementById('cancel-promoter-modal').classList.remove('hidden');
            } else if (promoter.status === 'Confirmed') {
                document.getElementById('manage-promoter-modal-title').textContent = `Manage Codes for ${promoter.name}`;
                document.getElementById('manage-promoter-modal').classList.remove('hidden');
            }
            modalBackdrop.classList.remove('hidden');
        }
        
        function handlePromoterAction(newStatus) {
            const promoterId = parseInt(document.getElementById('editing-promoter-id').value);
            const promoter = collaboratorsData.promoters.find(p => p.id === promoterId);
            if (!promoter) return;
            promoter.status = newStatus;
            renderPromoters();
            closeAllModals();
        }
        
        function setupCascadingCheckboxes() {
            const treeContainer = document.getElementById('gallery-permissions-tree');
            treeContainer.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const checkbox = e.target;
                    const parentDiv = checkbox.closest('div[style]');
                    const childCheckboxes = parentDiv.querySelectorAll('input[type="checkbox"]');
                    
                    for (let i = 1; i < childCheckboxes.length; i++) {
                        childCheckboxes[i].checked = checkbox.checked;
                    }
                }
            });
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderCreators();
            renderPromoters();
            setupCascadingCheckboxes();
        });
    </script>
    <script src="organizer.js" defer></script>
</body>
</html>
